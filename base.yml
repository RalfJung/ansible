# basic system preparation
- hosts: all
  tasks:
  # packages
  - name: check minimal system version
    command: "false"
    when: not (ansible_distribution == "Debian" and ansible_lsb.major_release|int >= 9)
  - name: detect if we have backports in the sources.list
    command: fgrep backports /etc/apt/sources.list
    register: backports
    failed_when: backports.rc == 2
  - name: add backports repository
    apt_repository: repo='deb http://httpredir.debian.org/debian {{ansible_distribution_release}}-backports main contrib non-free' state=present update_cache=yes
    when: backports.rc != 0
  - name: get rid of packages we do not want
    apt: name=exim4-base,rpcbind state=absent autoremove=yes
  - name: install needrestart, git
    apt: name=needrestart,git state=latest default_release={{ansible_distribution_release}}-backports
  # server-scripts
  - name: clone server-scripts git repository
    git:
      repo: 'git://ralfj.de/server-scripts'
      dest: /root/server-scripts
